import numpy as np
import os
import csv
from sys import byteorder
from sklearn import svm
from sklearn.metrics import confusion_matrix

n = 4
dir_name = './test/subs_bin'

dir = os.listdir(dir_name)
files = [f for f in dir if os.path.isfile(os.path.join(dir_name, f))]

ngram_list = []

for i in range(len(files)):
    file_name = dir_name + '/' + files[i]
    file_length = os.path.getsize(file_name)
    with open(file_name, 'rb') as f:
        j = 0
        while j < file_length - n + 1:
            b = f.read(n)
            ngram = int.from_bytes(b, byteorder='big')
            if(ngram not in ngram_list):
                ngram_list.append(ngram)
            #print(b)
            f.seek((1 - n), 1)
            j += 1

num_of_ransoms = len(files)

dir_name = './test/benign_bin'

dir = os.listdir(dir_name)
files = [f for f in dir if os.path.isfile(os.path.join(dir_name, f))]

for i in range(len(files)):
    file_name = dir_name + '/' + files[i]
    file_length = os.path.getsize(file_name)
    with open(file_name, 'rb') as f:
        j = 0
        while j < file_length - n + 1:
            b = f.read(n)
            ngram = int.from_bytes(b, byteorder='big')
            if(ngram not in ngram_list):
                ngram_list.append(ngram)
            #print(b)
            f.seek((1 - n), 1)
            j += 1

num_of_benigns = len(files)

l = 10
ngram_topl_list = []
ngram_count_list = [0] * len(ngram_list)

dir_name = './test/subs_bin'

dir = os.listdir(dir_name)
files = [f for f in dir if os.path.isfile(os.path.join(dir_name, f))]

for i in range(len(files)):
    file_name = dir_name + '/' + files[i]
    file_length = os.path.getsize(file_name)
    with open(file_name, 'rb') as f:
        j = 0
        while j < file_length - n + 1:
            b = f.read(n)
            ngram = int.from_bytes(b, byteorder='big')
            ngram_count_list[ngram_list.index(ngram)] += 1
            f.seek((1 - n), 1)
            j += 1

tmplist = np.array(ngram_count_list)
ngram_sorted_index_list = tmplist.argsort()[::-1]

for i in range(l):
    ngram_topl_list.append(ngram_list[ngram_sorted_index_list[i]])

samples = [[0] * (len(ngram_topl_list)+1) for i in range(num_of_ransoms + num_of_benigns)]
#samples = [[0] * (len(ngram_topl_list)+1)] * (num_of_ransoms + num_of_benigns)

dir_name = './test/subs_bin'

dir = os.listdir(dir_name)
files = [f for f in dir if os.path.isfile(os.path.join(dir_name, f))]

for i in range(0, num_of_ransoms):
    file_name = dir_name + '/' + files[i]
    file_length = os.path.getsize(file_name)
    with open(file_name, 'rb') as f:
        samples[i][0] = 1
        j = 0
        while j < file_length - n + 1:
            b = f.read(n)
            ngram = int.from_bytes(b, byteorder='big')
            if(ngram in ngram_topl_list):
                samples[i][ngram_topl_list.index(ngram) + 1] = 1
            f.seek((1 - n), 1)
            j += 1

dir_name = './test/benign_bin'

dir = os.listdir(dir_name)
files = [f for f in dir if os.path.isfile(os.path.join(dir_name, f))]

for i in range(num_of_ransoms, (num_of_ransoms + num_of_benigns)):
    file_name = dir_name + '/' + files[i - num_of_ransoms]
    file_length = os.path.getsize(file_name)
    with open(file_name, 'rb') as f:
        samples[i][0] = 0
        j = 0
        while j < file_length - n + 1:
            b = f.read(n)
            ngram = int.from_bytes(b, byteorder='big')
            if(ngram in ngram_topl_list):
                samples[i][ngram_topl_list.index(ngram) + 1] = 1
            f.seek((1 - n), 1)
            j += 1

print(samples)

f = open('svm_source.csv', 'w')
writer = csv.writer(f)
writer.writerows(samples)
f.close()


train_sample = np.genfromtxt('./svm_source.csv', delimiter=',')
train_label = train_sample[:, 0].astype(int)
train_data = train_sample[:, 1:]

model = svm.SVC(gamma="scale")
model.fit(train_data, train_label)

test_sample = np.genfromtxt('./svm_source.csv', delimiter=',')
test_label = test_sample[:, 0].astype(int)
test_data = test_sample[:, 1:]

print('Correct Label  :', test_label)
print('Predicted Label:', model.predict(test_data))
print('Test Score: ', model.score(test_data, test_label))